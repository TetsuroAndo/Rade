この度は、プルリクエストのコメントをトリガーとしてAIサービス（Devin-API）を連携させ、自動的に修正版プルリクエストを発行するシステムの構築フローに関するお問い合わせありがとうございます。

GitHub APIの情報を基に、botのコメントをトリガーとして別サービスAPIを呼び出すまでのフローと、そのために必要な情報を以下のドキュメントにまとめます。

---

## GitHubコメントトリガー型自動修正システム構築ドキュメント

### 1. システム概要と目的

本システムは、Code rabbitやcursor bag botなどの自動レビューボットが**Pull Request (PR)** に対して行ったコメントをフックとして捉え、そのフィードバック内容を外部のAIサービス（Devin-API）に送信し、AIが生成した修正内容を基に新しいプルリクエスト（修正版PR）を自動的に作成・発行することを目的とします。

### 2. フローの定義：GitHubコメントをトリガーに外部APIを呼び出すまで

外部サービス（Devin-API）を呼び出すまでのフローは、主にGitHub Webhookの設定とペイロードの処理によって構成されます。

| ステップ | 概要 | 必要なGitHub機能/API |
| :--- | :--- | :--- |
| **2.1. Webhookの設定** | 対象リポジトリで特定のイベントをトリガーするWebhookを設定します。 | リポジトリ Webhook |
| **2.2. イベントの受信** | GitHubからペイロード（データ）をサーバーが受信します。 | Webhookイベント（例: `issue_comment`, `pull_request_review_comment`） |
| **2.3. トリガーのフィルタリング** | 受信したイベントが、特定のボットによるコメントであることを確認します。 | ペイロード内の `user` および `body` 情報 |
| **2.4. 必須情報の抽出** | 外部API呼び出しに必要な情報をペイロードから抽出します。 | Pull Request 情報、コメント内容、コミット SHA |
| **2.5. 外部API呼び出し** | 抽出した情報をDevin-APIにリクエストとして送信します。 | 外部サービスのエンドポイント (Devin-API) |

---

### 3. ステップごとの詳細と必要な情報

#### 3.1. Webhook の設定とイベントの種類

システムが機能するための最も重要な要素は、GitHubからのイベント通知をリアルタイムで受け取ることです。これには**Webhook**を使用します。

1.  **Webhookの作成/設定**:
    *   Webhookはリポジトリごとに設定できます。
    *   CIサーバーの構築ガイドでは、Webhookを設定する際に、コンテンツタイプとして `application/x-www-form-urlencoded` を選択できることが示されていますが、JSON形式も一般的です。
    *   WebhookのURLとして、イベントを受信するサーバー（本システム）の公開URL（例: `ngrok` で提供されたURLなど）を指定します。

2.  **イベントの選択**:
    botによるコメントを捕捉するため、主に以下のイベントを購読する必要があります。

    *   **`issue_comment`**: Pull Requestの概要ページ（Issueと共通のエンドポイント）に対するコメントが作成、編集、または削除されたときに発生します。
    *   **`pull_request_review_comment`**: Pull Requestのファイルdiff内の特定の行に対してコメント（レビューコメント）が作成、編集、または削除されたときに発生します。
    *   （参考）`pull_request` イベント: PRがオープンされたり更新されたりしたときに発生し、このイベントにフックしてCI/CDを開始する例が示されています。しかし、今回の目的は**コメント**をトリガーとすることなので、上記のコメント系イベントがより適切です。

#### 3.2. コメントのフィルタリングとペイロード情報の抽出

Webhookによってサーバーに送信されるペイロード（JSONデータ）には、イベントに関する詳細情報が含まれています。

1.  **ボットの特定**:
    *   ペイロードにはコメントを行ったユーザーの情報（`user`オブジェクト）が含まれます。
    *   この `user` オブジェクト内の `login` フィールドを参照することで、コメントがCode rabbitやcursor bag botといった特定のボットによるものであるかを識別できます。

2.  **必要な情報の抽出**:
    Devin-APIに修正を依頼し、最終的に修正版PRを発行するために、以下のコア情報が必要です。

    | 情報のカテゴリー | 必要なデータ | ペイロード内の主な情報源（例） |
    | :--- | :--- | :--- |
    | **コメント/フィードバック** | 修正の指示、提案されたコードなど、ボットコメントの本文。 | `body` (コメント本文) |
    | **リポジトリ情報** | オーナー名とリポジトリ名。 | `owner`、`repo` (URLパスの一部として) |
    | **Pull Request情報** | PRを識別する番号。 | `issue_number` または `pull_number` |
    | **コードの場所（レビューコメントの場合）** | 修正対象のファイルパス、行番号、コミットSHA。 | `path`, `line`, `commit_id` |
    | **ブランチ情報** | 修正を行うためのベースとなるブランチのSHA。 | `commit_id` または `sha` (PRのheadコミット) |

    **ヒント: Pull RequestとIssueの関係**:
    GitHub APIにおいて、すべてのPull RequestはIssueの一種として扱われます。したがって、Pull Request全体のコメントを扱う場合、Issueコメント用のAPIエンドポイント（例: `/repos/{owner}/{repo}/issues/{issue_number}/comments`）を使用します。行に対するレビューコメントは、別のエンドポイント（`/repos/{owner}/{repo}/pulls/{pull_number}/comments`など）を使用します。

#### 3.3. 外部サービス (Devin-API) へのリクエスト送信

GitHub Webhookから抽出したデータを、Devin-APIが理解できる形式に変換し、HTTPリクエストとして送信します。

1.  **リクエスト内容**:
    *   Devin-APIに対して、どのリポジトリのどのファイルに対して、どのような修正コメントが出されたかを明確に伝達します。
    *   Devin-APIが修正ブランチを作成し直すために、現在のブランチ名や最新のコミットSHA（`commit_id`）を含めることが重要です。

2.  **認証とセキュリティ**:
    *   もしDevin-APIが認証を必要とする場合、適切なAPIキーやトークンを**GitHub Actions Secrets**や環境変数として安全に管理し、利用する必要があります。API資格情報は安全に保護されるべきです。

### 4. 修正版プルリクエスト発行のためのGitHub API (Devin-APIのアウトプット)

Devin-APIがコード修正を完了した後、GitHub上で修正版PRを発行するためには、GitHub REST APIの「Gitデータベース」および「Pull Request」エンドポイントを使用する必要があります。

1.  **Gitデータベースの操作（修正コミットの準備）**:
    *   修正内容をBlobとして作成し、ツリー構造を更新し、新しいコミットを作成する一連のGit操作が必要です。
    *   最終的に、新しいコミットSHAを指す新しいブランチ（参照: `refs/heads/new-fix-branch`）を作成します。

2.  **Pull Requestの作成**:
    *   新しい修正ブランチ（`head`）を、元のPRのターゲットブランチ（`base`）に向けて**Pull Requestを作成**します。
    *   エンドポイント: `POST /repos/{owner}/{repo}/pulls`。
    *   必須パラメーター: `title` (新しいPRのタイトル), `head` (修正ブランチ名), `base` (ターゲットブランチ名)。

3.  **認証**:
    *   新しいブランチを作成し、PRを発行するには、使用する認証トークンにリポジトリコンテンツに対する書き込み権限が必要です。
    *   **GitHub App インストール アクセス トークン (IAT)** または**きめ細かい個人用アクセス トークン (PAT)** を使用し、リポジトリに対する適切なアクセス許可（例: `contents` の `write` 権限、`pull requests` の `write` 権限など）を付与する必要があります。

### 5. 必要な情報と考慮事項のまとめ

| カテゴリ | 必要な情報/リソース | 考慮すべき点 |
| :--- | :--- | :--- |
| **GitHub API (入力)** | **Webhook URL**: イベントを受信するサーバーの公開エンドポイント。| ネットワーク設定（ngrokなどを使用するか、公開エンドポイントを用意する）。 |
| | **Webhook イベント**: `pull_request_review_comment` および `issue_comment`。 | どちらの種類のコメントに対応するかを明確にする。 |
| | **認証トークン**: GitHub API (コメントの取得、PRの作成/更新など) にアクセスするためのPATまたはGitHub Appトークン。 | トークンには適切な権限（issue/pull requestへの読み取り、コンテンツへの書き込み）が必要。 |
| **データ処理** | **ボットのユーザー名**: トリガーとするボット（Code rabbitなど）のGitHub上のユーザー名/ログイン名。 | ペイロード内の `user.login` を確認し、ボット以外のコメントを除外する。 |
| | **ペイロード抽出ロジック**: リポジトリ、PR番号、コミットSHA、コメント本文の抽出方法。 | どのコメントタイプ（レビューコメント/Issueコメント）に対応するかによって、ペイロードの構造が異なる。 |
| **外部連携 (Devin-API)** | **Devin-API エンドポイント**: 修正依頼を送信するAPIのURL。 | APIの仕様（リクエスト形式、認証方法、期待される応答形式）を確認する。 |
| | **Devin-API 認証情報**: 外部APIへのアクセスキー/シークレット。 | シークレットは環境変数や安全な方法で管理する。 |
| **GitHub API (出力)** | **PR作成エンドポイント**: `POST /repos/{owner}/{repo}/pulls`。 | 修正内容をプッシュするためのブランチ管理（新しいブランチを作成し、そこにコミットする）が必要となる。 |

### アナロジー

このシステム構築は、**「自動応答可能な郵便システム」**を構築する作業に似ています。

1.  **Webhookの設定**は、**郵便受け**を設置し、「PRコメント」という種類の郵便が届いたら、すぐに通知を受け取る仕組みです。
2.  **コメントのフィルタリング**は、届いた郵便のうち、特定の差出人（ボット）からの「修正指示書」だけを選び出す作業です。
3.  **情報の抽出**は、指示書に書かれた「対象リポジトリ名」「PR番号」「具体的な修正指示内容」といった必要な情報を整理することです。
4.  **Devin-APIへのリクエスト送信**は、整理した修正指示を外部の専門家（Devin）に送り、**「この情報に基づいて、修正済みの手紙を書き直してほしい」**と依頼する作業です。
5.  **修正版PRの発行**は、専門家から受け取った修正済みの手紙（コード）を、新しい封筒（ブランチ）に入れ、GitHub（ポスト）に戻してレビューを求める行為です。

このフローにより、人間が介在することなく、ボットのフィードバックからコード修正のサイクルを自動化できます。
